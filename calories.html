<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Calorie Tracker â€” Printbabe Style</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  :root{
    --lav: #E6E6FA;
    --pur: #9370DB;
    --dark: #4B0082;
  }
  body { font-family: "Inter", system-ui; background: var(--lav); color: var(--dark); }
  .pixel-shadow { box-shadow: 4px 4px 0 0 var(--dark); border:2px solid var(--dark); }
  .pixel-btn { box-shadow: 3px 3px 0 0 var(--dark); transition: all .1s; }
  .pixel-btn:active { box-shadow: 1px 1px 0 0 var(--dark); transform: translate(2px,2px); }
  .small { font-size:0.85rem }
  tbody tr:nth-child(odd) { background: #fff; }
  tbody tr:nth-child(even) { background: #f9f8ff; }
  .day-separator { background: #d8cfff; font-weight: bold; text-align:center; }
</style>
</head>
<body class="min-h-screen p-6">
<div class="max-w-6xl mx-auto">
  <!-- HEADER -->
  <header class="text-center mb-6 pixel-shadow bg-[color:var(--pur)] text-white p-4 rounded-lg">
    <h1 class="text-3xl font-bold tracking-widest">Calorie Tracker</h1>
    <p class="text-sm mt-1">Track calories, nutrients & goals â€” Printbabe style ðŸ’œ</p>
    <div id="profile-summary" class="mt-3 text-sm"></div>
  </header>

  <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- PROFILE -->
    <section class="pixel-shadow bg-white p-4 rounded-lg">
      <h2 class="text-lg font-bold mb-2">Profile & Target</h2>
      <form id="profile-form" class="space-y-3">
        <div>
          <label class="block small mb-1">Gender</label>
          <select id="gender" class="w-full p-2 border-2 border-[color:var(--dark)] rounded-sm bg-[color:var(--lav)]">
            <option value="male">Male</option>
            <option value="female">Female</option>
          </select>
        </div>
        <div class="grid grid-cols-3 gap-2">
          <div><label class="block small mb-1">Age</label><input id="age" type="number" min="4" class="w-full p-2 border-2 border-[color:var(--dark)] rounded-sm" /></div>
          <div><label class="block small mb-1">Height (cm)</label><input id="height" type="number" min="50" class="w-full p-2 border-2 border-[color:var(--dark)] rounded-sm" /></div>
          <div><label class="block small mb-1">Weight (kg)</label><input id="weight" type="number" min="10" step="0.1" class="w-full p-2 border-2 border-[color:var(--dark)] rounded-sm" /></div>
        </div>
        <div>
          <label class="block small mb-1">Activity</label>
          <select id="activity" class="w-full p-2 border-2 border-[color:var(--dark)] rounded-sm bg-[color:var(--lav)]">
            <option value="1.2">Sedentary</option>
            <option value="1.375">Lightly active</option>
            <option value="1.55">Moderately active</option>
            <option value="1.725">Very active</option>
            <option value="1.9">Extra active</option>
          </select>
        </div>
        <div>
          <label class="block small mb-1">Goal Type</label>
          <select id="goal-type" class="w-full p-2 border-2 border-[color:var(--dark)] rounded-sm bg-[color:var(--lav)]">
            <option value="maintain">Maintain Weight</option>
            <option value="lose">Lose Weight (-500 kcal)</option>
            <option value="gain">Gain Weight (+500 kcal)</option>
          </select>
        </div>
        <div class="flex gap-2">
          <button type="button" id="calc-target" class="w-full pixel-btn bg-[color:var(--pur)] text-white p-2 rounded">Save & Calculate</button>
          <button type="button" id="clear-profile" class="w-full pixel-btn bg-gray-300 text-black p-2 rounded">Clear</button>
        </div>
        <div class="mt-3 bg-[color:var(--lav)] border-2 border-[color:var(--dark)] p-3 rounded">
          <p class="small">BMR: <strong id="bmr">â€”</strong></p>
          <p class="small">Target: <strong id="daily-target" class="text-[color:var(--dark)] text-lg">â€”</strong></p>
        </div>
      </form>
    </section>

    <!-- EDIT MEAL MODAL -->
    <div id="edit-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden">
      <div class="bg-white p-6 rounded-lg w-full max-w-md pixel-shadow">
        <h2 class="text-lg font-bold mb-3">Edit Meal</h2>
        <div class="space-y-3">
          <input id="edit-date" type="date" class="w-full p-2 border-2 border-[color:var(--dark)] rounded-sm" />
          <input id="edit-name" placeholder="Food name" class="w-full p-2 border-2 border-[color:var(--dark)] rounded-sm" />
          <div class="grid grid-cols-4 gap-2">
            <input id="edit-calories" type="number" min="0" placeholder="Calories" class="p-2 border-2 border-[color:var(--dark)] rounded-sm" />
            <input id="edit-carbs" type="number" min="0" placeholder="Carbs" class="p-2 border-2 border-[color:var(--dark)] rounded-sm" />
            <input id="edit-protein" type="number" min="0" placeholder="Protein" class="p-2 border-2 border-[color:var(--dark)] rounded-sm" />
            <input id="edit-fat" type="number" min="0" placeholder="Fat" class="p-2 border-2 border-[color:var(--dark)] rounded-sm" />
          </div>
          <div class="flex justify-end gap-2 mt-2">
            <button id="modal-cancel" class="pixel-btn bg-gray-300 px-4 py-1 rounded">Cancel</button>
            <button id="modal-save" class="pixel-btn bg-[color:var(--pur)] text-white px-4 py-1 rounded">Save</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ADD / SEARCH MEAL -->
    <section class="col-span-2 pixel-shadow bg-white p-4 rounded-lg">
      <h2 class="text-lg font-bold mb-2">Add Meal / Search Food</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-3">
        <input id="meal-date" type="date" class="p-2 border-2 border-[color:var(--dark)] rounded-sm" />
        <input id="meal-name" placeholder="Food name (e.g., banana)" class="p-2 border-2 border-[color:var(--dark)] rounded-sm" />
      </div>

      <div class="grid grid-cols-1 md:grid-cols-5 gap-2 mb-2">
        <input id="grams" type="number" min="1" placeholder="Grams" class="p-2 border-2 border-[color:var(--dark)] rounded-sm" />
        <input id="calories" type="number" min="0" placeholder="Calories" class="p-2 border-2 border-[color:var(--dark)] rounded-sm" />
        <input id="carbs" type="number" min="0" placeholder="Carbs (g)" class="p-2 border-2 border-[color:var(--dark)] rounded-sm" />
        <input id="protein" type="number" min="0" placeholder="Protein (g)" class="p-2 border-2 border-[color:var(--dark)] rounded-sm" />
        <input id="fat" type="number" min="0" placeholder="Fat (g)" class="p-2 border-2 border-[color:var(--dark)] rounded-sm" />
      </div>

      <div class="flex gap-2 mb-2">
        <button id="search-food" class="pixel-btn bg-[color:var(--pur)] text-white p-2 rounded">Search Food</button>
        <button id="add-meal" class="pixel-btn bg-[color:var(--dark)] text-white p-2 rounded">Add Meal</button>
        <button id="reset-form" class="pixel-btn bg-gray-300 text-black p-2 rounded">Reset</button>
      </div>
    </section>

    <!-- MEAL LIST -->
    <section class="col-span-3 pixel-shadow bg-white p-4 rounded-lg">
      <div class="flex justify-between items-center mb-3">
        <h2 class="text-lg font-bold">Meal Log</h2>
        <div class="flex gap-2">
          <button id="download-data" class="pixel-btn bg-[color:var(--pur)] text-white px-3 py-1 rounded">Download Data</button>
          <button id="clear-all" class="pixel-btn bg-red-500 text-white px-3 py-1 rounded">Clear All</button>
        </div>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full border-collapse text-sm">
          <thead>
            <tr class="bg-[color:var(--pur)] text-white">
              <th class="p-2 border">Date</th>
              <th class="p-2 border">Food</th>
              <th class="p-2 border">kcal</th>
              <th class="p-2 border">Carbs</th>
              <th class="p-2 border">Protein</th>
              <th class="p-2 border">Fat</th>
              <th class="p-2 border">Actions</th>
            </tr>
          </thead>
          <tbody id="meals-tbody"></tbody>
        </table>
      </div>

      <div class="mt-4 bg-[color:var(--lav)] p-3 rounded border">
        <p><strong>Todayâ€™s total:</strong> <span id="today-cals">0</span> kcal</p>
      </div>
    </section>
  </main>
</div>

<script>
const PROFILE_KEY = 'ct_profile';
const MEALS_KEY = 'ct_meals';
let profile = JSON.parse(localStorage.getItem(PROFILE_KEY) || 'null');
let meals = JSON.parse(localStorage.getItem(MEALS_KEY) || '[]');

const gender = document.getElementById('gender');
const age = document.getElementById('age');
const height = document.getElementById('height');
const weight = document.getElementById('weight');
const activity = document.getElementById('activity');
const goalType = document.getElementById('goal-type');

const mealDate = document.getElementById('meal-date');
const mealName = document.getElementById('meal-name');
const grams = document.getElementById('grams');
const calories = document.getElementById('calories');
const carbs = document.getElementById('carbs');
const protein = document.getElementById('protein');
const fat = document.getElementById('fat');

let editIndex = null;

// Modal Elements
const editModal = document.getElementById('edit-modal');
const editDate = document.getElementById('edit-date');
const editName = document.getElementById('edit-name');
const editCalories = document.getElementById('edit-calories');
const editCarbs = document.getElementById('edit-carbs');
const editProtein = document.getElementById('edit-protein');
const editFat = document.getElementById('edit-fat');
const modalSave = document.getElementById('modal-save');
const modalCancel = document.getElementById('modal-cancel');

function saveProfile(){localStorage.setItem(PROFILE_KEY, JSON.stringify(profile));}
function saveMeals(){localStorage.setItem(MEALS_KEY, JSON.stringify(meals));}
function calcBMR(w,h,a,g){return g==='male'?10*w+6.25*h-5*a+5:10*w+6.25*h-5*a-161;}

function fillProfileFields(){
  if(!profile) return;
  gender.value = profile.gender;
  age.value = profile.age;
  height.value = profile.height;
  weight.value = profile.weight;
  activity.value = profile.activity;
  goalType.value = profile.goalType;
}

function updateProfileDisplay(){
  const bmrEl = document.getElementById('bmr');
  const dailyEl = document.getElementById('daily-target');
  const summary = document.getElementById('profile-summary');
  if(!profile){bmrEl.textContent='â€”';dailyEl.textContent='â€”';summary.textContent=''; return;}
  const bmr = calcBMR(profile.weight, profile.height, profile.age, profile.gender);
  let daily = bmr * parseFloat(profile.activity);
  if(profile.goalType==='lose') daily -= 500;
  if(profile.goalType==='gain') daily += 500;
  bmrEl.textContent = Math.round(bmr) + ' kcal';
  dailyEl.textContent = Math.round(daily) + ' kcal';
  summary.innerHTML = `<b>${profile.gender}</b>, ${profile.age} yrs, ${profile.height}cm / ${profile.weight}kg â€” <b>${Math.round(daily)} kcal/day</b>`;
}

document.getElementById('calc-target').onclick = ()=>{profile={gender:gender.value,age:+age.value,height:+height.value,weight:+weight.value,activity:activity.value,goalType:goalType.value};saveProfile();updateProfileDisplay();alert('Profile saved!');};
document.getElementById('clear-profile').onclick = ()=>{if(confirm('Clear profile?')){localStorage.removeItem(PROFILE_KEY); profile=null; updateProfileDisplay();}};

mealDate.value = new Date().toISOString().slice(0,10);

document.getElementById('add-meal').onclick = ()=>{
  if(!mealName.value) return alert('Enter food name');
  const mealObj = {date:mealDate.value,name:mealName.value,calories:+calories.value||0,carbs:+carbs.value||0,protein:+protein.value||0,fat:+fat.value||0};
  if(editIndex !== null){
    meals[editIndex] = mealObj;
    editIndex = null;
  } else meals.push(mealObj);
  saveMeals();
  renderMeals();
  document.getElementById('reset-form').click();
};

document.getElementById('reset-form').onclick = ()=>[mealName, grams, calories, carbs, protein, fat].forEach(i=>i.value='');

document.getElementById('search-food').onclick = async ()=>{
  if(!mealName.value) return alert('Enter food name');
  const btn = document.getElementById('search-food'); btn.textContent='Searching...';
  try{
    const res = await fetch(`https://world.openfoodfacts.org/cgi/search.pl?search_terms=${mealName.value}&json=1&page_size=1`);
    const data = await res.json();
    const p = data.products?.[0]?.nutriments;
    if(p){
      calories.value = p['energy-kcal_100g'] || 0;
      carbs.value = p['carbohydrates_100g'] || 0;
      protein.value = p['proteins_100g'] || 0;
      fat.value = p['fat_100g'] || 0;
      alert('Auto-filled!');
    } else alert('No data found');
  } catch(e){alert('Error fetching');}
  btn.textContent='Search Food';
};

// Render Meal Table
function renderMeals(){
  const tbody = document.getElementById('meals-tbody');
  tbody.innerHTML = '';
  if(meals.length===0){tbody.innerHTML=`<tr><td colspan='7' class='text-center p-2 text-gray-500'>No meals yet</td></tr>`; return;}
  const grouped={};
  meals.forEach((m,i)=>{if(!grouped[m.date]) grouped[m.date]=[]; grouped[m.date].push({...m,index:i});});
  Object.keys(grouped).sort().forEach(date=>{
    tbody.innerHTML += `<tr class="day-separator"><td colspan="7">${date}</td></tr>`;
    grouped[date].forEach(m=>{
      tbody.innerHTML += `<tr>
        <td class='border p-1'>${m.date}</td>
        <td class='border p-1'>${m.name}</td>
        <td class='border p-1'>${m.calories}</td>
        <td class='border p-1'>${m.carbs}</td>
        <td class='border p-1'>${m.protein}</td>
        <td class='border p-1'>${m.fat}</td>
        <td class='border p-1'>
          <button class='pixel-btn bg-yellow-400 text-black px-2 py-0.5 rounded' onclick='openEditModal(${m.index})'>Edit</button>
          <button class='pixel-btn bg-red-500 text-white px-2 py-0.5 rounded' onclick='deleteMeal(${m.index})'>Delete</button>
        </td>
      </tr>`;
    });
  });
  updateTotals();
}

// Open Modal
function openEditModal(i){
  const m = meals[i];
  editIndex = i;
  editDate.value = m.date;
  editName.value = m.name;
  editCalories.value = m.calories;
  editCarbs.value = m.carbs;
  editProtein.value = m.protein;
  editFat.value = m.fat;
  editModal.classList.remove('hidden');
}

// Save modal
modalSave.onclick = ()=>{
  if(editIndex===null) return;
  meals[editIndex] = {
    date:editDate.value,
    name:editName.value,
    calories:+editCalories.value||0,
    carbs:+editCarbs.value||0,
    protein:+editProtein.value||0,
    fat:+editFat.value||0
  };
  saveMeals(); renderMeals();
  editIndex=null; editModal.classList.add('hidden');
};

// Cancel modal
modalCancel.onclick = ()=>{editIndex=null; editModal.classList.add('hidden');};

function deleteMeal(i){if(confirm('Delete this meal?')){meals.splice(i,1);saveMeals();renderMeals();}}

function updateTotals(){const today=new Date().toISOString().slice(0,10);const total=meals.filter(m=>m.date===today).reduce((s,m)=>s+(+m.calories||0),0);document.getElementById('today-cals').textContent=total.toFixed(1);}

document.getElementById('clear-all').onclick = ()=>{ if(confirm('Delete all meals?')){meals=[];saveMeals();renderMeals();} };

fillProfileFields(); updateProfileDisplay(); renderMeals();
</script>
</body>
</html>
